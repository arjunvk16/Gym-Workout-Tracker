<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Workout Tracker</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FullCalendar for the calendar view -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>
    
    <!-- Chart.js for graphs on the canvas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Marked.js for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        /* Custom styles for FullCalendar */
        :root {
            --fc-border-color: #e2e8f0;
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 10px;
            --fc-list-event-hover-bg-color: #f1f5f9;
        }
        .fc .fc-button-primary {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .fc .fc-button-primary:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        .fc .fc-daygrid-day.fc-day-today {
            background-color: #eff6ff;
        }
        .fc-event {
            cursor: pointer;
        }
        /* Simple transition for cards */
        .card {
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        /* Custom scrollbar for chat */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Markdown rendering styles */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
    </style>
</head>
<body class="antialiased text-slate-700">
    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Sign in to your account
                </h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign in
                    </button>
                </div>
            </form>
            <div class="text-sm text-center">
                <p>Don't have an account? 
                    <button id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">
                        Register here
                    </button>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container (hidden by default) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-800">Gym Tracker</h1>
                    <p id="user-email-display" class="mt-2 text-sm text-slate-500">Logged in as...</p>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">
                    Logout
                </button>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column: Forms -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Log Daily Workout -->
                    <div id="workout-card" class="card bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-bold mb-4 text-slate-800">Log Daily Workout</h2>
                        <form id="workout-form" class="space-y-4">
                            <div>
                                <label for="exercise-select" class="block text-sm font-medium text-slate-600">Exercise Name</label>
                                <select id="exercise-select" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                                <input type="text" id="new-exercise-name" class="hidden mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="e.g., Deadlift">
                                <button type="button" id="toggle-exercise-input-btn" class="mt-2 text-sm text-blue-600 hover:underline">Or, add a new exercise</button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600">Sets & Weight (kg)</label>
                                <div id="sets-container" class="space-y-2 mt-1"></div>
                                <button type="button" id="add-set-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ Add Set</button>
                            </div>
                            <div>
                                <label for="workout-date" class="block text-sm font-medium text-slate-600">Date</label>
                                <input type="date" id="workout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add Workout</button>
                        </form>
                    </div>

                    <!-- Log Body Measurements -->
                    <div id="measurements-card" class="card bg-white p-6 rounded-xl shadow-sm">
                         <h2 class="text-xl font-bold mb-4 text-slate-800">Log Body Measurements</h2>
                        <form id="measurement-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="body-weight" class="block text-sm font-medium text-slate-600">Weight (kg)</label>
                                    <input type="number" step="0.1" id="body-weight" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="75.5">
                                </div>
                                <div>
                                    <label for="chest-size" class="block text-sm font-medium text-slate-600">Chest (cm)</label>
                                    <input type="number" step="0.1" id="chest-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="102">
                                </div>
                                <div>
                                    <label for="biceps-size" class="block text-sm font-medium text-slate-600">Biceps (cm)</label>
                                    <input type="number" step="0.1" id="biceps-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="38">
                                </div>
                                 <div>
                                    <label for="stomach-size" class="block text-sm font-medium text-slate-600">Stomach (cm)</label>
                                    <input type="number" step="0.1" id="stomach-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="85">
                                </div>
                                <div>
                                    <label for="age" class="block text-sm font-medium text-slate-600">Age</label>
                                    <input type="number" id="age" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="25">
                                </div>
                                <div>
                                    <label for="height" class="block text-sm font-medium text-slate-600">Height (cm)</label>
                                    <input type="number" step="0.1" id="height" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="180">
                                </div>
                            </div>
                             <div>
                                <label for="measurement-date" class="block text-sm font-medium text-slate-600">Date</label>
                                <input type="date" id="measurement-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700">Save Measurements</button>
                        </form>
                    </div>
                </div>

                <!-- Right Column: Calendar and Graph -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="card bg-white p-6 rounded-xl shadow-sm"><div id='calendar'></div></div>
                    <div class="card bg-white p-6 rounded-xl shadow-sm">
                         <h2 class="text-xl font-bold mb-4 text-slate-800">Progress Graph</h2>
                        <div>
                            <label for="chart-select" class="block text-sm font-medium text-slate-600">Select data to view</label>
                            <select id="chart-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 rounded-md"></select>
                        </div>
                        <div class="mt-4 h-80 relative">
                            <canvas id="progress-chart"></canvas>
                            <div id="chart-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-400">
                                <p>Select a metric from the dropdown to see your progress.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis & Chat -->
                <div class="lg:col-span-3 card bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-500">Gemini AI</span> Fitness Coach
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Analysis Section -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Overall Progress Analysis</h3>
                            <button id="analyze-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all duration-300">
                                ✨ Analyze My Progress
                            </button>
                            <div id="analysis-result-container" class="mt-4 p-4 border rounded-lg bg-gray-50 h-96 overflow-y-auto custom-scrollbar">
                                <div id="analysis-placeholder" class="text-slate-400 flex items-center justify-center h-full">Click the button to get an AI-powered analysis of your progress.</div>
                                <div id="analysis-loading" class="hidden text-slate-500">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-purple-500 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Analyzing data...
                                </div>
                                <div id="analysis-result" class="markdown-content"></div>
                            </div>
                        </div>
                        <!-- Chat Section -->
                        <div>
                             <h3 class="text-lg font-semibold mb-2">Chat with Your Data</h3>
                            <div id="chat-container" class="border rounded-lg h-96 flex flex-col bg-gray-50">
                                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4 custom-scrollbar">
                                     <div class="text-center text-sm text-slate-400">Ask a question about your workouts, like "How is my bench press progressing?"</div>
                                </div>
                                <div id="chat-loading" class="p-4 border-t hidden">
                                    <p class="text-sm text-slate-500">Gemini is thinking...</p>
                                </div>
                                <form id="chat-form" class="p-2 border-t flex gap-2 bg-white">
                                    <input type="text" id="chat-input" class="flex-grow p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Ask about your progress...">
                                    <button type="submit" class="bg-blue-600 text-white px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300">Send</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Modals (Edit, Message, Confirm) -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Edit Workout</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="edit-workout-form" class="space-y-4 text-left">
                        <input type="hidden" id="edit-doc-id">
                        <div>
                           <label for="edit-exercise-name" class="block text-sm font-medium text-slate-600">Exercise Name</label>
                            <input type="text" id="edit-exercise-name" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-slate-300 rounded-md" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600">Sets & Weight (kg)</label>
                            <div id="edit-sets-container" class="space-y-2 mt-1">
                                <!-- Dynamic sets for editing will be added here -->
                            </div>
                            <button type="button" id="edit-add-set-btn" class="mt-2 text-sm text-blue-600 hover:underline focus:outline-none">
                                + Add Set
                            </button>
                        </div>
                         <div>
                            <label for="edit-workout-date" class="block text-sm font-medium text-slate-600">Date</label>
                            <input type="date" id="edit-workout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md" required>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3 gap-2 flex justify-end">
                    <button id="delete-workout-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Delete
                    </button>
                    <button id="update-workout-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Save Changes
                    </button>
                     <button id="close-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <p id="message-text" class="text-center text-lg"></p>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <p id="confirm-text" class="text-center text-lg mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Yes</button>
                <button id="confirm-no-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">No</button>
            </div>
        </div>
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const GEMINI_API_KEY = 'AIzaSyAEI4iMpOqIsfbSpY9lYlOKAgixUQXQ6ps';
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        
        let userId = null;
        let calendar;
        let progressChart;
        let workoutUnsubscribe = () => {};
        let measurementUnsubscribe = () => {};
        let exerciseUnsubscribe = () => {};
        let isAddingNewExercise = false;
        
        const appId = 'gym-tracker-default';

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        // ... (other DOM elements)
        const workoutForm = document.getElementById('workout-form');
        const chartSelect = document.getElementById('chart-select');
        // ... (and so on for all elements)
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisResultContainer = document.getElementById('analysis-result-container');
        const analysisPlaceholder = document.getElementById('analysis-placeholder');
        const analysisLoading = document.getElementById('analysis-loading');
        const analysisResult = document.getElementById('analysis-result');
        const chatContainer = document.getElementById('chat-container');
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatLoading = document.getElementById('chat-loading');
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const measurementForm = document.getElementById('measurement-form');
        const chartCanvas = document.getElementById('progress-chart');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const editModal = document.getElementById('edit-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const updateWorkoutBtn = document.getElementById('update-workout-btn');
        const deleteWorkoutBtn = document.getElementById('delete-workout-btn');
        const exerciseSelect = document.getElementById('exercise-select');
        const newExerciseNameInput = document.getElementById('new-exercise-name');
        const toggleExerciseBtn = document.getElementById('toggle-exercise-input-btn');
        const setsContainer = document.getElementById('sets-container');
        const addSetBtn = document.getElementById('add-set-btn');
        const editSetsContainer = document.getElementById('edit-sets-container');
        const editAddSetBtn = document.getElementById('edit-add-set-btn');
        const confirmModal = document.getElementById('confirm-modal');
        

        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userEmailDisplay.textContent = `Logged in as: ${user.email}`;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initAppForUser();
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupOnLogout();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['email-address'].value;
            const password = loginForm['password'].value;
            const isRegistering = loginForm.dataset.register === 'true';

            try {
                if (isRegistering) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("Registration successful! You are now logged in.");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                loginForm.reset();
            } catch (error) {
                showMessage(error.message, true);
            }
        });
        
        showRegisterBtn.addEventListener('click', () => {
            const isRegistering = loginForm.dataset.register === 'true';
            if (isRegistering) {
                loginForm.querySelector('button[type="submit"]').textContent = 'Sign in';
                loginForm.parentElement.querySelector('h2').textContent = 'Sign in to your account';
                showRegisterBtn.innerHTML = `Don't have an account? <span class="font-medium text-blue-600 hover:text-blue-500">Register here</span>`;
                loginForm.dataset.register = 'false';
            } else {
                loginForm.querySelector('button[type="submit"]').textContent = 'Register';
                loginForm.parentElement.querySelector('h2').textContent = 'Create a new account';
                showRegisterBtn.innerHTML = `Already have an account? <span class="font-medium text-blue-600 hover:text-blue-500">Sign in</span>`;
                loginForm.dataset.register = 'true';
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        function initAppForUser() {
            if (!userId) return;
            setsContainer.innerHTML = '';
            setsContainer.appendChild(createSetInput());
            setupEventListeners();
            initCalendar();
            loadDataAndPopulateDropdown();
            listenForExerciseUpdates();
        }
        
        function cleanupOnLogout() {
            workoutUnsubscribe();
            measurementUnsubscribe();
            exerciseUnsubscribe();
            if (calendar) calendar.removeAllEvents();
            if (progressChart) progressChart.destroy();
        }

        // --- Gemini API Function ---
        async function callGeminiAPI(prompt) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    throw new Error('Failed to fetch from Gemini API.');
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error(error);
                return "Sorry, I couldn't get a response from the AI coach right now.";
            }
        }
        
        async function formatDataForAI() {
            if (!userId) return "No data available.";
            
            const workoutQuery = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
            const measurementQuery = query(collection(db, `artifacts/${appId}/users/${userId}/measurements`));
            
            const [workoutSnapshot, measurementSnapshot] = await Promise.all([
                getDocs(workoutQuery),
                getDocs(measurementQuery)
            ]);

            let dataString = "WORKOUT DATA:\n";
            const workouts = workoutSnapshot.docs
                .map(d => d.data())
                .sort((a,b) => new Date(a.date) - new Date(b.date));
            
            workouts.forEach(w => {
                const maxWeight = Array.isArray(w.weights) ? Math.max(...w.weights) : w.weight;
                dataString += `- ${w.date}, ${w.exercise}: Max weight ${maxWeight} kg, Sets: ${w.weights ? w.weights.length : 1}\n`;
            });

            dataString += "\nBODY MEASUREMENT DATA:\n";
            const measurements = measurementSnapshot.docs
                .map(d => d.data())
                .sort((a,b) => new Date(a.date) - new Date(b.date));
            
            measurements.forEach(m => {
                dataString += `- ${m.date}: ` + Object.entries(m)
                    .filter(([key, val]) => key !== 'date' && val != null)
                    .map(([key, val]) => `${key}: ${val}`)
                    .join(', ') + '\n';
            });
            
            return dataString;
        }

        async function handleAnalysisRequest() {
            analysisPlaceholder.classList.add('hidden');
            analysisResult.innerHTML = '';
            analysisLoading.classList.remove('hidden');

            const data = await formatDataForAI();
            const prompt = `You are a world-class fitness and strength coach. Analyze the following workout and body measurement data for a user. Provide a concise, encouraging, and actionable summary.

            Here is the data:
            ${data}

            Your analysis should include:
            1. An overall summary of progress. Are they getting stronger?
            2. Point out 1-2 specific exercises where they have shown the most improvement.
            3. Identify any potential plateaus or exercises that haven't progressed.
            4. Based on the data, provide one key suggestion for their next week of training.
            5. Briefly comment on their body measurement changes if available.
            6. If height and weight data are available, calculate the Body Mass Index (BMI) and comment on it.

            Keep the tone positive and motivating. Format the output using markdown for readability.`;
            
            const response = await callGeminiAPI(prompt);
            analysisLoading.classList.add('hidden');
            analysisResult.innerHTML = marked.parse(response);
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput) return;
            
            chatForm.querySelector('button').disabled = true;
            chatInput.value = '';
            
            appendChatMessage(userInput, 'user');
            chatLoading.classList.remove('hidden');
            
            const dataContext = await formatDataForAI();
            const prompt = `You are a fitness coach. Based on the user's data below, answer their question concisely.
            
            USER'S DATA: 
            ${dataContext}

            USER'S QUESTION: "${userInput}"
            `;
            
            const response = await callGeminiAPI(prompt);
            chatLoading.classList.add('hidden');
            appendChatMessage(response, 'gemini');
            chatForm.querySelector('button').disabled = false;
        }
        
        function appendChatMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-2 rounded-lg max-w-xs ${sender === 'user' ? 'bg-blue-500 text-white self-end ml-auto' : 'bg-gray-200 text-slate-800 self-start mr-auto'}`;
            messageDiv.innerHTML = marked.parse(message); // Use marked for consistency
            
            // Remove initial placeholder if it exists
            const initialPlaceholder = chatHistory.querySelector('.text-center');
            if(initialPlaceholder) initialPlaceholder.remove();

            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll to bottom
        }

        function createSetInput(weight = '') {
            const setWrapper = document.createElement('div');
            setWrapper.className = 'flex items-center gap-2';
            
            const weightInput = document.createElement('input');
            weightInput.type = 'number';
            weightInput.step = '0.5';
            weightInput.className = 'set-weight-input mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500';
            weightInput.placeholder = 'e.g., 60';
            weightInput.value = weight;
            weightInput.required = true;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '✕';
            removeBtn.className = 'text-red-500 hover:text-red-700 font-bold';
            removeBtn.onclick = () => {
                if (setWrapper.parentElement.childElementCount > 1) {
                    setWrapper.remove();
                } else {
                    showMessage("You must have at least one set.", true);
                }
            };
            
            setWrapper.appendChild(weightInput);
            setWrapper.appendChild(removeBtn);
            
            return setWrapper;
        }

        function setupEventListeners() {
            // Re-bind listeners for the logged-in user
            workoutForm.onsubmit = handleWorkoutSubmit;
            measurementForm.onsubmit = handleMeasurementSubmit;
            chartSelect.onchange = handleChartSelection;
            if(closeModalBtn) closeModalBtn.onclick = () => editModal.classList.add('hidden');
            if(updateWorkoutBtn) updateWorkoutBtn.onclick = handleUpdateWorkout;
            if(deleteWorkoutBtn) deleteWorkoutBtn.onclick = handleDeleteWorkout;
            toggleExerciseBtn.onclick = toggleExerciseInput;
            addSetBtn.onclick = () => setsContainer.appendChild(createSetInput());
            if(editAddSetBtn) editAddSetBtn.onclick = () => editSetsContainer.appendChild(createSetInput());
            analyzeBtn.onclick = handleAnalysisRequest;
            chatForm.onsubmit = handleChatSubmit;
        }
        
        // ... (rest of the functions: toggleExerciseInput, handleWorkoutSubmit, etc. remain the same)
        
        async function handleWorkoutSubmit(e) {
            e.preventDefault();
            const exercise = isAddingNewExercise ? newExerciseNameInput.value.trim() : exerciseSelect.value;
            const weights = Array.from(setsContainer.querySelectorAll('.set-weight-input')).map(input => parseFloat(input.value)).filter(w => !isNaN(w) && w > 0);
            const date = workoutForm['workout-date'].value;

            if (exercise && weights.length > 0 && date) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/workouts`), { exercise, weights, date });
                    showMessage("Workout added!");
                    workoutForm.reset();
                    setsContainer.innerHTML = '';
                    setsContainer.appendChild(createSetInput());
                    workoutForm['workout-date'].value = new Date().toISOString().split('T')[0];
                    if (isAddingNewExercise) toggleExerciseInput();
                } catch (error) { showMessage("Failed to add workout.", true); }
            } else { showMessage("Please fill all workout fields correctly.", true); }
        }
        
        async function handleMeasurementSubmit(e) {
            e.preventDefault();
            const date = measurementForm['measurement-date'].value;
            if (!date) { showMessage("Please select a date for measurements.", true); return; }
            const data = { 
                date, 
                weight: parseFloat(measurementForm['body-weight'].value) || null, 
                chest: parseFloat(measurementForm['chest-size'].value) || null, 
                biceps: parseFloat(measurementForm['biceps-size'].value) || null, 
                stomach: parseFloat(measurementForm['stomach-size'].value) || null,
                age: parseInt(measurementForm['age'].value) || null,
                height: parseFloat(measurementForm['height'].value) || null
            };
            if (!Object.values(data).some((v, i) => i > 0 && v !== null)) { showMessage("Please enter at least one measurement.", true); return; }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/measurements`, date), data, { merge: true });
                showMessage("Measurements saved!");
                measurementForm.reset();
                measurementForm['measurement-date'].value = new Date().toISOString().split('T')[0];
            } catch (error) { showMessage("Failed to save measurements.", true); }
        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (calendar) calendar.destroy();
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                events: [],
                eventClick: handleEventClick,
            });
            calendar.render();
            listenForWorkoutUpdates();
        }

        function listenForWorkoutUpdates() {
            if(!userId) return;
            workoutUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
            workoutUnsubscribe = onSnapshot(q, (snapshot) => {
                const events = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const displayWeight = Array.isArray(data.weights) && data.weights.length > 0 ? Math.max(...data.weights) : data.weight || 0;
                    return { id: doc.id, title: `${data.exercise} - ${displayWeight} kg`, start: data.date, extendedProps: data };
                });
                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                }
            });
        }
        
        function handleEventClick(info) {
             const data = info.event.extendedProps;
            editModal.querySelector('#modal-title').textContent = `Edit: ${data.exercise}`;
            editModal.querySelector('#edit-doc-id').value = info.event.id;
            editModal.querySelector('#edit-exercise-name').value = data.exercise;
            editModal.querySelector('#edit-workout-date').value = data.date;

            const editSetsContainer = document.getElementById('edit-sets-container');
            editSetsContainer.innerHTML = '';
            if (Array.isArray(data.weights) && data.weights.length > 0) {
                data.weights.forEach(weight => editSetsContainer.appendChild(createSetInput(weight)));
            } else if (data.weight) { // For backward compatibility
                editSetsContainer.appendChild(createSetInput(data.weight));
            } else {
                editSetsContainer.appendChild(createSetInput());
            }

            editModal.classList.remove('hidden');
        }
        
        async function handleUpdateWorkout() {
            const docId = editModal.querySelector('#edit-doc-id').value;
            const editSetsContainer = document.getElementById('edit-sets-container');
            const weightInputs = editSetsContainer.querySelectorAll('.set-weight-input');
            const weights = Array.from(weightInputs)
                                 .map(input => parseFloat(input.value))
                                 .filter(w => !isNaN(w) && w > 0);
            const date = editModal.querySelector('#edit-workout-date').value;
            
            if (!docId || weights.length === 0 || !date) {
                showMessage("Invalid data. Please check all fields.", true);
                return;
            }
            
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/workouts`, docId);
                await updateDoc(docRef, { weights, date });
                showMessage("Workout updated successfully!");
                editModal.classList.add('hidden');
            } catch (error) {
                console.error("Error updating workout: ", error);
                showMessage("Failed to update workout.", true);
            }
        }

        async function handleDeleteWorkout() {
            const docId = editModal.querySelector('#edit-doc-id').value;
            if (!docId) return;

            showConfirm("Are you sure you want to delete this workout?", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/workouts`, docId));
                    showMessage("Workout deleted!");
                    editModal.classList.add('hidden');
                } catch (error) {
                    showMessage("Delete failed.", true);
                }
            });
        }
        
        function listenForExerciseUpdates() {
            if(!userId) return;
            exerciseUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
            exerciseUnsubscribe = onSnapshot(q, (snapshot) => {
                const exercises = [...new Set(snapshot.docs.map(doc => doc.data().exercise))];
                populateExerciseDropdown(exercises.sort());
            });
        }
        
        function populateExerciseDropdown(exercises) {
            const currentSelection = exerciseSelect.value;
            exerciseSelect.innerHTML = '<option value="">Select an exercise</option>'; // Keep the placeholder
            exercises.forEach(ex => {
                const optionEl = document.createElement('option');
                optionEl.value = ex;
                optionEl.textContent = ex;
                exerciseSelect.appendChild(optionEl);
            });
            exerciseSelect.value = currentSelection;
        }
        
        function loadDataAndPopulateDropdown() {
             if(!userId) return;
             measurementUnsubscribe();
             const q = query(collection(db, `artifacts/${appId}/users/${userId}/measurements`));
             measurementUnsubscribe = onSnapshot(q, () => populateChartDropdown());
        }

        async function populateChartDropdown() {
            const currentSelection = chartSelect.value;
            chartSelect.innerHTML = '<option value="">Choose data...</option>';
            
            const measurementGroup = document.createElement('optgroup');
            measurementGroup.label = "Body Measurements";
            ['Weight', 'Chest', 'Biceps', 'Stomach'].forEach(opt => {
                const optionEl = document.createElement('option');
                optionEl.value = `measurement_${opt.toLowerCase()}`;
                optionEl.textContent = opt;
                measurementGroup.appendChild(optionEl);
            });
            chartSelect.appendChild(measurementGroup);
            
            if (!userId) return;
            const workoutSnapshot = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/workouts`)));
            const exercises = [...new Set(workoutSnapshot.docs.map(doc => doc.data().exercise))];
            
            if(exercises.length > 0) {
                const exerciseGroup = document.createElement('optgroup');
                exerciseGroup.label = "Exercises";
                exercises.sort().forEach(ex => {
                    const optionEl = document.createElement('option');
                    optionEl.value = `exercise_${ex}`;
                    optionEl.textContent = ex;
                    exerciseGroup.appendChild(optionEl);
                });
                chartSelect.appendChild(exerciseGroup);
            }
            chartSelect.value = currentSelection;
        }
        
        async function handleChartSelection() {
            const selectedValue = chartSelect.value;
            if (!selectedValue) {
                if (progressChart) progressChart.destroy();
                chartPlaceholder.classList.remove('hidden');
                return;
            }

            chartPlaceholder.classList.add('hidden');
            const [type, key] = selectedValue.split('_');
            let data, labels, labelText, collectionName, dataKey;

            if (type === 'measurement') {
                collectionName = 'measurements';
                dataKey = key;
                labelText = `${key.charAt(0).toUpperCase() + key.slice(1)} Progress`;
            } else {
                collectionName = 'workouts';
                labelText = `${key} Progress (kg)`;
            }
            
            const q = type === 'exercise' 
                ? query(collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`), where('exercise', '==', key))
                : query(collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`));

            const snapshot = await getDocs(q);
            
            const sortedData = snapshot.docs
                .map(doc => doc.data())
                .filter(d => {
                    if (type === 'measurement') return d[dataKey] != null;
                    return d.weight != null || (Array.isArray(d.weights) && d.weights.length > 0);
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            labels = sortedData.map(d => d.date);
            if (type === 'measurement') {
                data = sortedData.map(d => d[dataKey]);
            } else {
                data = sortedData.map(d => {
                    if (Array.isArray(d.weights) && d.weights.length > 0) return Math.max(...d.weights);
                    return d.weight || 0;
                });
            }

            drawChart(labels, data, labelText);
        }

        function drawChart(labels, data, label) {
            if (progressChart) {
                progressChart.destroy();
            }
            progressChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.2,
                        pointBackgroundColor: '#3b82f6',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false } }
                }
            });
        }
        
        function showMessage(text, isError = false) {
            const modal = document.getElementById('message-modal');
            const textEl = document.getElementById('message-text');
            textEl.textContent = text;
            textEl.className = `text-center text-lg ${isError ? 'text-red-600' : 'text-green-600'}`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 2000);
        }

        function showConfirm(text, onConfirm) {
            const confirmText = document.getElementById('confirm-text');
            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');
            
            confirmText.textContent = text;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');

            const yesHandler = () => {
                onConfirm();
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                yesBtn.removeEventListener('click', yesHandler);
                noBtn.removeEventListener('click', noHandler);
            };
            const noHandler = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                yesBtn.removeEventListener('click', yesHandler);
                noBtn.removeEventListener('click', noHandler);
            };

            yesBtn.addEventListener('click', yesHandler);
            noBtn.addEventListener('click', noHandler);
        }
        
        function toggleExerciseInput() {
            isAddingNewExercise = !isAddingNewExercise;
            if (isAddingNewExercise) {
                exerciseSelect.classList.add('hidden');
                newExerciseNameInput.classList.remove('hidden');
                newExerciseNameInput.focus();
                toggleExerciseBtn.textContent = 'Or, select an existing exercise';
                exerciseSelect.value = '';
                newExerciseNameInput.required = true;
                exerciseSelect.required = false;
            } else {
                exerciseSelect.classList.remove('hidden');
                newExerciseNameInput.classList.add('hidden');
                toggleExerciseBtn.textContent = 'Or, add a new exercise';
                newExerciseNameInput.value = '';
                newExerciseNameInput.required = false;
                exerciseSelect.required = true;
            }
        }
    </script>

</body>
</html>

