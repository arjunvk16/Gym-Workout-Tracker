<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Workout Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FullCalendar for the calendar view -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>
    
    <!-- Chart.js for graphs on the canvas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        /* Custom styles for FullCalendar */
        :root {
            --fc-border-color: #e2e8f0;
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 10px;
            --fc-list-event-hover-bg-color: #f1f5f9;
        }
        .fc .fc-button-primary {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .fc .fc-button-primary:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        .fc .fc-daygrid-day.fc-day-today {
            background-color: #eff6ff;
        }
        .fc-event {
            cursor: pointer;
        }
        /* Simple transition for cards */
        .card {
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body class="antialiased text-slate-700">
    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Sign in to your account
                </h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign in
                    </button>
                </div>
            </form>
            <div class="text-sm text-center">
                <p>Don't have an account? 
                    <button id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">
                        Register here
                    </button>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container (hidden by default) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-800">Gym Tracker</h1>
                    <p id="user-email-display" class="mt-2 text-sm text-slate-500">Logged in as...</p>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">
                    Logout
                </button>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column: Forms -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Log Daily Workout -->
                    <div id="workout-card" class="card bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-bold mb-4 text-slate-800">Log Daily Workout</h2>
                        <form id="workout-form" class="space-y-4">
                            <div>
                                <label for="exercise-select" class="block text-sm font-medium text-slate-600">Exercise Name</label>
                                <select id="exercise-select" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                                <input type="text" id="new-exercise-name" class="hidden mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="e.g., Deadlift">
                                <button type="button" id="toggle-exercise-input-btn" class="mt-2 text-sm text-blue-600 hover:underline">Or, add a new exercise</button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600">Sets & Weight (kg)</label>
                                <div id="sets-container" class="space-y-2 mt-1"></div>
                                <button type="button" id="add-set-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ Add Set</button>
                            </div>
                            <div>
                                <label for="workout-date" class="block text-sm font-medium text-slate-600">Date</label>
                                <input type="date" id="workout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add Workout</button>
                        </form>
                    </div>

                    <!-- Log Body Measurements -->
                    <div id="measurements-card" class="card bg-white p-6 rounded-xl shadow-sm">
                         <h2 class="text-xl font-bold mb-4 text-slate-800">Log Body Measurements</h2>
                        <form id="measurement-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="body-weight" class="block text-sm font-medium text-slate-600">Weight (kg)</label>
                                    <input type="number" step="0.1" id="body-weight" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="75.5">
                                </div>
                                <div>
                                    <label for="chest-size" class="block text-sm font-medium text-slate-600">Chest (cm)</label>
                                    <input type="number" step="0.1" id="chest-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="102">
                                </div>
                                <div>
                                    <label for="biceps-size" class="block text-sm font-medium text-slate-600">Biceps (cm)</label>
                                    <input type="number" step="0.1" id="biceps-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="38">
                                </div>
                                 <div>
                                    <label for="stomach-size" class="block text-sm font-medium text-slate-600">Stomach (cm)</label>
                                    <input type="number" step="0.1" id="stomach-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="85">
                                </div>
                            </div>
                             <div>
                                <label for="measurement-date" class="block text-sm font-medium text-slate-600">Date</label>
                                <input type="date" id="measurement-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700">Save Measurements</button>
                        </form>
                    </div>
                </div>

                <!-- Right Column: Calendar and Graph -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="card bg-white p-6 rounded-xl shadow-sm"><div id='calendar'></div></div>
                    <div class="card bg-white p-6 rounded-xl shadow-sm">
                         <h2 class="text-xl font-bold mb-4 text-slate-800">Progress Graph</h2>
                        <div>
                            <label for="chart-select" class="block text-sm font-medium text-slate-600">Select data to view</label>
                            <select id="chart-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 rounded-md"></select>
                        </div>
                        <div class="mt-4 h-80 relative">
                            <canvas id="progress-chart"></canvas>
                            <div id="chart-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-400">
                                <p>Select a metric from the dropdown to see your progress.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals (Edit, Message, Confirm) -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">...</div>
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50">...</div>
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <p id="confirm-text" class="text-center text-lg mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Yes</button>
                <button id="confirm-no-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">No</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId = null;
        let calendar;
        let progressChart;
        let workoutUnsubscribe = () => {};
        let measurementUnsubscribe = () => {};
        let exerciseUnsubscribe = () => {};
        let isAddingNewExercise = false;
        
        const appId = 'gym-tracker-default';

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutBtn = document.getElementById('logout-btn');
        // ... (all other DOM elements remain the same)
        const workoutForm = document.getElementById('workout-form');
        const measurementForm = document.getElementById('measurement-form');
        const chartSelect = document.getElementById('chart-select');
        const chartCanvas = document.getElementById('progress-chart');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const editModal = document.getElementById('edit-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const updateWorkoutBtn = document.getElementById('update-workout-btn');
        const deleteWorkoutBtn = document.getElementById('delete-workout-btn');
        const exerciseSelect = document.getElementById('exercise-select');
        const newExerciseNameInput = document.getElementById('new-exercise-name');
        const toggleExerciseBtn = document.getElementById('toggle-exercise-input-btn');
        const setsContainer = document.getElementById('sets-container');
        const addSetBtn = document.getElementById('add-set-btn');
        const editSetsContainer = document.getElementById('edit-sets-container');
        const editAddSetBtn = document.getElementById('edit-add-set-btn');
        const confirmModal = document.getElementById('confirm-modal');


        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is logged in
                userId = user.uid;
                userEmailDisplay.textContent = `Logged in as: ${user.email}`;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initAppForUser();
            } else {
                // User is logged out
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupOnLogout();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['email-address'].value;
            const password = loginForm['password'].value;
            const isRegistering = loginForm.dataset.register === 'true';

            try {
                if (isRegistering) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("Registration successful! You are now logged in.");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                loginForm.reset();
            } catch (error) {
                console.error("Auth Error:", error.message);
                showMessage(error.message, true);
            }
        });
        
        showRegisterBtn.addEventListener('click', () => {
            const isRegistering = loginForm.dataset.register === 'true';
            if (isRegistering) {
                loginForm.querySelector('button[type="submit"]').textContent = 'Sign in';
                loginForm.parentElement.querySelector('h2').textContent = 'Sign in to your account';
                showRegisterBtn.innerHTML = `Don't have an account? <span class="font-medium text-blue-600 hover:text-blue-500">Register here</span>`;
                loginForm.dataset.register = 'false';
            } else {
                loginForm.querySelector('button[type="submit"]').textContent = 'Register';
                loginForm.parentElement.querySelector('h2').textContent = 'Create a new account';
                showRegisterBtn.innerHTML = `Already have an account? <span class="font-medium text-blue-600 hover:text-blue-500">Sign in</span>`;
                loginForm.dataset.register = 'true';
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        function initAppForUser() {
            if (!userId) return;
            setsContainer.innerHTML = '';
            setsContainer.appendChild(createSetInput());
            setupEventListeners();
            initCalendar();
            loadDataAndPopulateDropdown();
            listenForExerciseUpdates();
        }
        
        function cleanupOnLogout() {
            workoutUnsubscribe();
            measurementUnsubscribe();
            exerciseUnsubscribe();
            if (calendar) calendar.removeAllEvents();
            if (progressChart) progressChart.destroy();
        }

        // --- The rest of your app logic (UI Helpers, Data Handling, Calendar, Chart) remains largely the same ---
        // ... but make sure it's called inside initAppForUser() or setupEventListeners()
        
        function createSetInput(weight = '') {
            const setWrapper = document.createElement('div');
            setWrapper.className = 'flex items-center gap-2';
            
            const weightInput = document.createElement('input');
            weightInput.type = 'number';
            weightInput.step = '0.5';
            weightInput.className = 'set-weight-input mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500';
            weightInput.placeholder = 'e.g., 60';
            weightInput.value = weight;
            weightInput.required = true;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '✕';
            removeBtn.className = 'text-red-500 hover:text-red-700 font-bold';
            removeBtn.onclick = () => {
                if (setWrapper.parentElement.childElementCount > 1) {
                    setWrapper.remove();
                } else {
                    showMessage("You must have at least one set.", true);
                }
            };
            
            setWrapper.appendChild(weightInput);
            setWrapper.appendChild(removeBtn);
            
            return setWrapper;
        }

        function setupEventListeners() {
            // Re-bind listeners for the logged-in user
            workoutForm.onsubmit = handleWorkoutSubmit;
            measurementForm.onsubmit = handleMeasurementSubmit;
            chartSelect.onchange = handleChartSelection;
            if(closeModalBtn) closeModalBtn.onclick = () => editModal.classList.add('hidden');
            if(updateWorkoutBtn) updateWorkoutBtn.onclick = handleUpdateWorkout;
            if(deleteWorkoutBtn) deleteWorkoutBtn.onclick = handleDeleteWorkout;
            toggleExerciseBtn.onclick = toggleExerciseInput;
            addSetBtn.onclick = () => setsContainer.appendChild(createSetInput());
            if(editAddSetBtn) editAddSetBtn.onclick = () => editSetsContainer.appendChild(createSetInput());
        }
        
        function toggleExerciseInput() {
            isAddingNewExercise = !isAddingNewExercise;
            if (isAddingNewExercise) {
                exerciseSelect.classList.add('hidden');
                newExerciseNameInput.classList.remove('hidden');
                newExerciseNameInput.focus();
                toggleExerciseBtn.textContent = 'Or, select an existing exercise';
                exerciseSelect.value = '';
                newExerciseNameInput.required = true;
                exerciseSelect.required = false;
            } else {
                exerciseSelect.classList.remove('hidden');
                newExerciseNameInput.classList.add('hidden');
                toggleExerciseBtn.textContent = 'Or, add a new exercise';
                newExerciseNameInput.value = '';
                newExerciseNameInput.required = false;
                exerciseSelect.required = true;
            }
        }

        async function handleWorkoutSubmit(e) {
            e.preventDefault();
            const exercise = isAddingNewExercise ? newExerciseNameInput.value.trim() : exerciseSelect.value;
            const weights = Array.from(setsContainer.querySelectorAll('.set-weight-input')).map(input => parseFloat(input.value)).filter(w => !isNaN(w) && w > 0);
            const date = workoutForm['workout-date'].value;

            if (exercise && weights.length > 0 && date) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/workouts`), { exercise, weights, date });
                    showMessage("Workout added!");
                    workoutForm.reset();
                    setsContainer.innerHTML = '';
                    setsContainer.appendChild(createSetInput());
                    workoutForm['workout-date'].value = new Date().toISOString().split('T')[0];
                    if (isAddingNewExercise) toggleExerciseInput();
                } catch (error) { showMessage("Failed to add workout.", true); }
            } else { showMessage("Please fill all workout fields correctly.", true); }
        }
        
        async function handleMeasurementSubmit(e) {
            e.preventDefault();
            const date = measurementForm['measurement-date'].value;
            if (!date) { showMessage("Please select a date for measurements.", true); return; }
            const data = { date, weight: parseFloat(measurementForm['body-weight'].value) || null, chest: parseFloat(measurementForm['chest-size'].value) || null, biceps: parseFloat(measurementForm['biceps-size'].value) || null, stomach: parseFloat(measurementForm['stomach-size'].value) || null };
            if (!Object.values(data).some((v, i) => i > 0 && v !== null)) { showMessage("Please enter at least one measurement.", true); return; }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/measurements`, date), data, { merge: true });
                showMessage("Measurements saved!");
                measurementForm.reset();
                measurementForm['measurement-date'].value = new Date().toISOString().split('T')[0];
            } catch (error) { showMessage("Failed to save measurements.", true); }
        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (calendar) calendar.destroy();
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                events: [],
                eventClick: handleEventClick,
            });
            calendar.render();
            listenForWorkoutUpdates();
        }

        function listenForWorkoutUpdates() {
            if(!userId) return;
            workoutUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
            workoutUnsubscribe = onSnapshot(q, (snapshot) => {
                const events = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const displayWeight = Array.isArray(data.weights) && data.weights.length > 0 ? Math.max(...data.weights) : data.weight || 0;
                    return { id: doc.id, title: `${data.exercise} - ${displayWeight} kg`, start: data.date, extendedProps: data };
                });
                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                }
            });
        }
        
        function handleEventClick(info) {
             // Code to populate and show edit-modal
        }
        
        async function handleUpdateWorkout() {
            // Code to update workout
        }

        async function handleDeleteWorkout() {
            const docId = editModal.querySelector('#edit-doc-id').value;
            if (!docId) return;

            showConfirm("Are you sure you want to delete this workout?", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/workouts`, docId));
                    showMessage("Workout deleted!");
                    editModal.classList.add('hidden');
                } catch (error) {
                    showMessage("Delete failed.", true);
                }
            });
        }
        
        function listenForExerciseUpdates() {
            if(!userId) return;
            exerciseUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
            exerciseUnsubscribe = onSnapshot(q, (snapshot) => {
                const exercises = [...new Set(snapshot.docs.map(doc => doc.data().exercise))];
                populateExerciseDropdown(exercises.sort());
            });
        }
        
        function populateExerciseDropdown(exercises) {
            // code to populate exercise dropdown
        }
        
        function loadDataAndPopulateDropdown() {
             if(!userId) return;
             measurementUnsubscribe();
             const q = query(collection(db, `artifacts/${appId}/users/${userId}/measurements`));
             measurementUnsubscribe = onSnapshot(q, () => populateChartDropdown());
        }

        async function populateChartDropdown() {
            // code to populate chart dropdown
        }
        
        async function handleChartSelection() {
            // code to handle chart selection and draw chart
        }

        function drawChart(labels, data, label) {
            // code to draw chart
        }
        
        function showMessage(text, isError = false) {
            // code to show message modal
        }

        function showConfirm(text, onConfirm) {
            const confirmText = document.getElementById('confirm-text');
            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');
            
            confirmText.textContent = text;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');

            const yesHandler = () => {
                onConfirm();
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                yesBtn.removeEventListener('click', yesHandler);
                noBtn.removeEventListener('click', noHandler);
            };
            const noHandler = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                yesBtn.removeEventListener('click', yesHandler);
                noBtn.removeEventListener('click', noHandler);
            };

            yesBtn.addEventListener('click', yesHandler);
            noBtn.addEventListener('click', noHandler);
        }
    </script>

</body>
</html>

