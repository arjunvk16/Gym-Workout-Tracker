<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Workout Tracker</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FullCalendar for the calendar view -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>
    
    <!-- Chart.js for graphs on the canvas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Marked.js for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        /* Custom styles for FullCalendar */
        :root {
            --fc-border-color: #e2e8f0;
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 10px;
            --fc-list-event-hover-bg-color: #f1f5f9;
        }
        .fc .fc-button-primary {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .fc .fc-button-primary:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        .fc .fc-daygrid-day.fc-day-today {
            background-color: #eff6ff;
        }
        .fc-event {
            cursor: pointer;
        }
        .fc .fc-event-title-container {
            font-weight: 500;
        }
        /* Simple transition for cards */
        .card {
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        /* Custom scrollbar for chat */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Markdown rendering styles */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        /* Toggle switch style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="antialiased text-slate-700">
    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Sign in to your account
                </h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign in
                    </button>
                </div>
            </form>
            <div class="text-sm text-center">
                <p>Don't have an account? 
                    <button id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">
                        Register here
                    </button>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container (hidden by default) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
            <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-800">Gym Tracker</h1>
                    <p id="user-email-display" class="mt-2 text-sm text-slate-500">Logged in as...</p>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">
                    Logout
                </button>
            </header>
            
            <!-- Navigation Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <div class="overflow-x-auto">
                    <nav class="-mb-px flex space-x-6 sm:space-x-8" aria-label="Tabs">
                        <button id="tab-dashboard" class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Dashboard</button>
                        <button id="tab-log" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Log Workout</button>
                        <button id="tab-running" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hidden">Log Run</button>
                        <button id="tab-ai" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">AI Coach</button>
                        <button id="tab-settings" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Settings</button>
                    </nav>
                </div>
            </div>
            
            <main>
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view">
                     <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-slate-800" id="welcome-message">Welcome!</h2>
                     <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6">
                        <!-- Streak Card -->
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm flex flex-col items-center justify-center text-center">
                            <div class="text-5xl sm:text-6xl mb-2">üî•</div>
                            <div class="text-4xl sm:text-5xl font-bold text-slate-800" id="streak-count">0</div>
                            <div class="text-slate-500 text-sm sm:text-base">Day Streak</div>
                        </div>
                        <!-- Total Workouts Card -->
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm flex flex-col items-center justify-center text-center">
                            <div class="text-5xl sm:text-6xl mb-2">üí™</div>
                            <div class="text-4xl sm:text-5xl font-bold text-slate-800" id="total-workouts">0</div>
                            <div class="text-slate-500 text-sm sm:text-base">Total Workouts</div>
                        </div>
                        <!-- Total Weight Card -->
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm flex flex-col items-center justify-center text-center">
                            <div class="text-5xl sm:text-6xl mb-2">üèãÔ∏è</div>
                            <div class="text-3xl sm:text-4xl font-bold text-slate-800" id="total-weight">0 <span class="text-xl sm:text-2xl font-medium">kg</span></div>
                            <div class="text-slate-500 text-sm sm:text-base">Total Weight</div>
                        </div>
                        <!-- Total Distance Card -->
                        <div id="total-distance-card" class="bg-white p-4 sm:p-6 rounded-xl shadow-sm flex-col items-center justify-center text-center hidden">
                            <div class="text-5xl sm:text-6xl mb-2">üèÉ‚Äç‚ôÇÔ∏è</div>
                            <div class="text-3xl sm:text-4xl font-bold text-slate-800" id="total-distance">0 <span class="text-xl sm:text-2xl font-medium">km</span></div>
                            <div class="text-slate-500 text-sm sm:text-base">Total Distance</div>
                        </div>
                        <!-- Achievements Card -->
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm flex flex-col items-center justify-center text-center">
                            <div class="text-5xl sm:text-6xl mb-2">üèÜ</div>
                            <div class="text-3xl sm:text-4xl font-bold text-slate-800" id="achievements-unlocked">0/0</div>
                            <div class="text-slate-500 text-sm sm:text-base">Achievements</div>
                             <button id="view-achievements-btn" class="mt-3 text-sm text-blue-600 hover:underline">View All</button>
                        </div>
                     </div>
                     <div class="mt-8 text-center">
                        <button id="start-workout-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg">
                            Log Today's Workout
                        </button>
                     </div>
                </div>

                <!-- Log & View Data View -->
                <div id="view-log" class="view hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                         <!-- Left Column: Forms -->
                        <div class="lg:col-span-1 space-y-6">
                            <!-- Log Daily Workout -->
                            <div id="workout-card" class="card bg-white p-6 rounded-xl shadow-sm">
                                <h2 class="text-xl font-bold mb-4 text-slate-800">Log Daily Workout</h2>
                                <form id="workout-form" class="space-y-4">
                                     <div>
                                        <label for="workout-tag" class="block text-sm font-medium text-slate-600">Workout Tag (e.g., Leg Day)</label>
                                        <input type="text" id="workout-tag" list="workout-tags-list" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="Optional">
                                        <datalist id="workout-tags-list"></datalist>
                                    </div>
                                    <div>
                                        <label for="exercise-search" class="block text-sm font-medium text-slate-600">Search or Select Exercise</label>
                                        <input type="text" id="exercise-search" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="Type to search...">
                                        <select id="exercise-select" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                                        <input type="text" id="new-exercise-name" class="hidden mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="e.g., Deadlift">
                                        <button type="button" id="toggle-exercise-input-btn" class="mt-2 text-sm text-blue-600 hover:underline">Or, add a new exercise</button>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Sets & Weight (kg)</label>
                                        <div id="sets-container" class="space-y-2 mt-1"></div>
                                        <button type="button" id="add-set-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ Add Set</button>
                                    </div>
                                    <div>
                                        <label for="workout-date" class="block text-sm font-medium text-slate-600">Date</label>
                                        <input type="date" id="workout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add Workout</button>
                                </form>
                            </div>

                            <!-- Log Body Measurements -->
                            <div id="measurements-card" class="card bg-white p-6 rounded-xl shadow-sm">
                                 <h2 class="text-xl font-bold mb-4 text-slate-800">Log Body Measurements</h2>
                                <form id="measurement-form" class="space-y-4">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="body-weight" class="block text-sm font-medium text-slate-600">Weight (kg)</label>
                                            <input type="number" step="0.1" id="body-weight" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="75.5">
                                        </div>
                                        <div>
                                            <label for="bust-line" class="block text-sm font-medium text-slate-600">Bust Line (cm)</label>
                                            <input type="number" step="0.1" id="bust-line" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="102">
                                        </div>
                                        <div>
                                            <label for="waist-line" class="block text-sm font-medium text-slate-600">Waist Line (cm)</label>
                                            <input type="number" step="0.1" id="waist-line" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="85">
                                        </div>
                                        <div>
                                            <label for="hip-line" class="block text-sm font-medium text-slate-600">Hip Line (cm)</label>
                                            <input type="number" step="0.1" id="hip-line" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="95">
                                        </div>
                                        <div>
                                            <label for="biceps-size" class="block text-sm font-medium text-slate-600">Biceps (cm)</label>
                                            <input type="number" step="0.1" id="biceps-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="38">
                                        </div>
                                        <div>
                                            <label for="forearms-size" class="block text-sm font-medium text-slate-600">Forearms (cm)</label>
                                            <input type="number" step="0.1" id="forearms-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="30">
                                        </div>
                                        <div>
                                            <label for="thighs-size" class="block text-sm font-medium text-slate-600">Thighs (cm)</label>
                                            <input type="number" step="0.1" id="thighs-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="60">
                                        </div>
                                        <div>
                                            <label for="calves-size" class="block text-sm font-medium text-slate-600">Calves (cm)</label>
                                            <input type="number" step="0.1" id="calves-size" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="40">
                                        </div>
                                        <div>
                                            <label for="smm" class="block text-sm font-medium text-slate-600">SMM (kg)</label>
                                            <input type="number" step="0.1" id="smm" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="35.5">
                                        </div>
                                        <div>
                                            <label for="pbf" class="block text-sm font-medium text-slate-600">PBF (%)</label>
                                            <input type="number" step="0.1" id="pbf" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="15.2">
                                        </div>
                                        <div>
                                            <label for="age" class="block text-sm font-medium text-slate-600">Age</label>
                                            <input type="number" id="age" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="25">
                                        </div>
                                        <div>
                                            <label for="height" class="block text-sm font-medium text-slate-600">Height (cm)</label>
                                            <input type="number" step="0.1" id="height" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="180">
                                        </div>
                                    </div>
                                     <div>
                                        <label for="measurement-date" class="block text-sm font-medium text-slate-600">Date</label>
                                        <input type="date" id="measurement-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                                    </div>
                                    <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700">Save Measurements</button>
                                </form>
                            </div>
                        </div>

                        <!-- Right Column: Calendar and Graph -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="card bg-white p-6 rounded-xl shadow-sm"><div id='calendar'></div></div>
                            <div class="card bg-white p-6 rounded-xl shadow-sm">
                                 <h2 class="text-xl font-bold mb-4 text-slate-800">Progress Graph</h2>
                                <div>
                                    <label for="chart-select" class="block text-sm font-medium text-slate-600">Select data to view</label>
                                    <select id="chart-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 rounded-md"></select>
                                </div>
                                <div class="mt-4 h-80 relative">
                                    <canvas id="progress-chart"></canvas>
                                    <div id="chart-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-400">
                                        <p>Select a metric from the dropdown to see your progress.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <!-- Running View -->
                <div id="view-running" class="view hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                             <div class="card bg-white p-6 rounded-xl shadow-sm">
                                <h2 class="text-xl font-bold mb-4 text-slate-800">Log a Run</h2>
                                <form id="running-form" class="space-y-4">
                                    <div>
                                        <label for="run-date" class="block text-sm font-medium text-slate-600">Date</label>
                                        <input type="date" id="run-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                                    </div>
                                    <div>
                                        <label for="run-distance" class="block text-sm font-medium text-slate-600">Distance (km)</label>
                                        <input type="number" step="0.1" id="run-distance" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="5.0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Duration</label>
                                        <div class="grid grid-cols-3 gap-2 mt-1">
                                            <input type="number" id="run-duration-hr" class="w-full px-3 py-2 border rounded-md" placeholder="hr">
                                            <input type="number" id="run-duration-min" class="w-full px-3 py-2 border rounded-md" placeholder="min">
                                            <input type="number" id="run-duration-sec" class="w-full px-3 py-2 border rounded-md" placeholder="sec">
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700">Log Run</button>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                             <div class="card bg-white p-6 rounded-xl shadow-sm">
                                 <h2 class="text-xl font-bold mb-4 text-slate-800">Running Progress</h2>
                                <div>
                                    <label for="running-chart-select" class="block text-sm font-medium text-slate-600">Select metric to view</label>
                                    <select id="running-chart-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 rounded-md">
                                        <option value="distance">Distance (km)</option>
                                        <option value="duration">Duration (min)</option>
                                    </select>
                                </div>
                                <div class="mt-4 h-80 relative">
                                    <canvas id="running-progress-chart"></canvas>
                                    <div id="running-chart-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-400">
                                        <p>Log a run to see your progress.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Coach View -->
                <div id="view-ai" class="view hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Analysis Section -->
                        <div class="card bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="text-lg font-semibold mb-2">Overall Progress Analysis</h3>
                            <button id="analyze-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all duration-300">
                                ‚ú® Analyze My Progress
                            </button>
                            <div id="analysis-result-container" class="mt-4 p-4 border rounded-lg bg-gray-50 h-96 overflow-y-auto custom-scrollbar">
                                <div id="analysis-placeholder" class="text-slate-400 flex items-center justify-center h-full">Click the button to get an AI-powered analysis of your progress.</div>
                                <div id="analysis-loading" class="hidden text-slate-500">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-purple-500 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Analyzing data...
                                </div>
                                <div id="analysis-result" class="markdown-content"></div>
                            </div>
                        </div>
                        <!-- Chat Section -->
                        <div class="card bg-white p-6 rounded-xl shadow-sm">
                             <h3 class="text-lg font-semibold mb-2">Chat with Your Data</h3>
                            <div id="chat-container" class="border rounded-lg h-96 flex flex-col bg-gray-50">
                                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4 custom-scrollbar">
                                     <div class="text-center text-sm text-slate-400">Ask a question about your workouts, like "How is my bench press progressing?"</div>
                                </div>
                                <div id="chat-loading" class="p-4 border-t hidden">
                                    <p class="text-sm text-slate-500">Gemini is thinking...</p>
                                </div>
                                <form id="chat-form" class="p-2 border-t flex gap-2 bg-white">
                                    <input type="text" id="chat-input" class="flex-grow p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Ask about your progress...">
                                    <button type="submit" class="bg-blue-600 text-white px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300">Send</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="view-settings" class="view hidden">
                    <div class="card bg-white p-6 rounded-xl shadow-sm max-w-md mx-auto">
                        <h2 class="text-xl font-bold mb-4 text-slate-800">App Settings</h2>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Enable Running Log</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="enable-running-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="enable-running-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="achievements-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
         <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Achievements</h3>
                <button id="close-achievements-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
             </div>
             <div id="achievements-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto p-2">
                <!-- Achievements will be populated here -->
             </div>
         </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Edit Workout</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="edit-workout-form" class="space-y-4 text-left">
                        <input type="hidden" id="edit-doc-id">
                        <div>
                           <label for="edit-workout-tag" class="block text-sm font-medium text-slate-600">Workout Tag</label>
                            <input type="text" id="edit-workout-tag" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md">
                        </div>
                        <div>
                           <label for="edit-exercise-name" class="block text-sm font-medium text-slate-600">Exercise Name</label>
                            <input type="text" id="edit-exercise-name" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-slate-300 rounded-md" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600">Sets & Weight (kg)</label>
                            <div id="edit-sets-container" class="space-y-2 mt-1"></div>
                            <button type="button" id="edit-add-set-btn" class="mt-2 text-sm text-blue-600 hover:underline focus:outline-none">+ Add Set</button>
                        </div>
                         <div>
                            <label for="edit-workout-date" class="block text-sm font-medium text-slate-600">Date</label>
                            <input type="date" id="edit-workout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md" required>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3 gap-2 flex justify-end">
                    <button id="delete-workout-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto hover:bg-red-600">Delete</button>
                    <button id="update-workout-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto hover:bg-blue-600">Save</button>
                     <button id="close-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto hover:bg-gray-300">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto flex items-center gap-4">
            <div id="message-icon" class="text-3xl"></div>
            <p id="message-text" class="text-center text-lg"></p>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <p id="confirm-text" class="text-center text-lg mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Yes</button>
                <button id="confirm-no-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">No</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, setDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const GEMINI_API_KEY = 'AIzaSyAEI4iMpOqIsfbSpY9lYlOKAgixUQXQ6ps';
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        
        let userId = null;
        let calendar;
        let progressChart;
        let runningProgressChart;
        let isAddingNewExercise = false;
        let allExercises = [];
        
        const appId = 'gym-tracker-default';
        let unsubscribes = [];

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const workoutForm = document.getElementById('workout-form');
        const chartSelect = document.getElementById('chart-select');
        const runningChartSelect = document.getElementById('running-chart-select');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisResult = document.getElementById('analysis-result');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutBtn = document.getElementById('logout-btn');
        const measurementForm = document.getElementById('measurement-form');
        const chartCanvas = document.getElementById('progress-chart');
        const runningChartCanvas = document.getElementById('running-progress-chart');
        const editModal = document.getElementById('edit-modal');
        const exerciseSearchInput = document.getElementById('exercise-search');
        const exerciseSelect = document.getElementById('exercise-select');
        const newExerciseNameInput = document.getElementById('new-exercise-name');
        const setsContainer = document.getElementById('sets-container');
        const confirmModal = document.getElementById('confirm-modal');
        const tabs = document.querySelectorAll('.tab-btn');
        const views = document.querySelectorAll('.view');
        
        
        // --- Achievements Definitions ---
        const achievements = [
            { id: 'first_workout', name: 'Getting Started', description: 'Log your very first workout.', emoji: 'üéâ', condition: stats => stats.totalWorkouts >= 1 },
            { id: 'streak_3', name: 'Consistency is Key', description: 'Maintain a 3-day workout streak.', emoji: 'ü•â', condition: stats => stats.streak >= 3 },
            { id: 'streak_7', name: 'On a Roll', description: 'Maintain a 7-day workout streak.', emoji: 'ü•à', condition: stats => stats.streak >= 7 },
            { id: 'streak_30', name: 'Habit Formed', description: 'Maintain a 30-day workout streak.', emoji: 'ü•á', condition: stats => stats.streak >= 30 },
            { id: 'total_workouts_10', name: 'Regular', description: 'Complete 10 workouts.', emoji: 'üí™', condition: stats => stats.totalWorkouts >= 10 },
            { id: 'total_workouts_50', name: 'Veteran', description: 'Complete 50 workouts.', emoji: 'üî•', condition: stats => stats.totalWorkouts >= 50 },
            { id: 'total_weight_10000', name: 'Heavy Lifter', description: 'Lift a total of 10,000 kg.', emoji: 'üèãÔ∏è', condition: stats => stats.totalWeightLifted >= 10000 },
            { id: 'total_weight_100000', name: 'Titan', description: 'Lift a total of 100,000 kg.', emoji: 'üí•', condition: stats => stats.totalWeightLifted >= 100000 },
        ];
        
        
        // --- Authentication & App Initialization ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userEmailDisplay.textContent = `Logged in as: ${user.email}`;
                document.getElementById('welcome-message').textContent = `Welcome back!`;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initAppForUser();
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupOnLogout();
            }
        });

        function initAppForUser() {
            if (!userId) return;
            setsContainer.innerHTML = '';
            setsContainer.appendChild(createSetInput());
            setupAppEventListeners();
            initCalendar();
            
            // Listen to all data changes
            const workoutQuery = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
            const runsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/runs`));
            const measurementQuery = query(collection(db, `artifacts/${appId}/users/${userId}/measurements`));
            const achievementsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/achievements`));
            const settingsDoc = doc(db, `artifacts/${appId}/users/${userId}/settings/appSettings`);

            const unsubSettings = onSnapshot(settingsDoc, (docSnap) => {
                applySettings(docSnap.data());
            });

            const unsubWorkouts = onSnapshot(workoutQuery, () => {
                updateAllDynamicContent();
            });

            const unsubRuns = onSnapshot(runsQuery, () => {
                updateAllDynamicContent();
                handleRunningChartSelection();
            });

            const unsubMeasurements = onSnapshot(measurementQuery, () => {
                updateDashboardAndAchievements();
            });
            const unsubAchievements = onSnapshot(achievementsQuery, snapshot => renderAchievementsPage(snapshot.docs));
            
            unsubscribes.push(unsubWorkouts, unsubRuns, unsubMeasurements, unsubAchievements, unsubSettings);
            
            updateDashboardAndAchievements();
        }

        async function updateAllDynamicContent() {
             const workoutQuery = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
             const runsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/runs`));
             const [workoutSnapshot, runsSnapshot] = await Promise.all([getDocs(workoutQuery), getDocs(runsQuery)]);

             updateCalendar(workoutSnapshot.docs, runsSnapshot.docs);
             populateExerciseDropdownAndTags(workoutSnapshot.docs);
             populateChartDropdown(workoutSnapshot.docs);
             updateDashboardAndAchievements();
        }
        
        async function updateDashboardAndAchievements() {
            const stats = await calculateUserStats();
            renderDashboard(stats);
            checkAndUnlockAchievements(stats);
        }

        function cleanupOnLogout() {
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            if (calendar) calendar.removeAllEvents();
            if (progressChart) progressChart.destroy();
            if (runningProgressChart) runningProgressChart.destroy();
        }
        
        // --- Event Listeners Setup ---
        function setupAuthEventListeners() {
            loginForm.onsubmit = handleAuthFormSubmit;
            document.getElementById('show-register-btn').onclick = toggleAuthMode;
        }

        function setupAppEventListeners() {
            logoutBtn.onclick = () => signOut(auth);
            
            tabs.forEach(tab => {
                tab.onclick = (e) => {
                    const viewId = `view-${e.currentTarget.id.split('-')[1]}`;
                    
                    tabs.forEach(t => {
                        t.classList.remove('border-blue-500', 'text-blue-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    e.currentTarget.classList.add('border-blue-500', 'text-blue-600');
                    e.currentTarget.classList.remove('border-transparent', 'text-gray-500');
                    
                    views.forEach(view => view.classList.add('hidden'));
                    document.getElementById(viewId).classList.remove('hidden');

                    if(viewId === 'view-log' && calendar) {
                        setTimeout(() => calendar.render(), 10);
                    }
                    if(viewId === 'view-running') {
                        handleRunningChartSelection();
                    }
                };
            });
            
            document.getElementById('start-workout-btn').onclick = () => document.getElementById('tab-log').click();
            document.getElementById('view-achievements-btn').onclick = () => document.getElementById('achievements-modal').classList.remove('hidden');
            document.getElementById('close-achievements-modal-btn').onclick = () => document.getElementById('achievements-modal').classList.add('hidden');
            
            workoutForm.onsubmit = handleWorkoutSubmit;
            measurementForm.onsubmit = handleMeasurementSubmit;
            document.getElementById('running-form').onsubmit = handleRunningSubmit;
            
            document.getElementById('enable-running-toggle').onchange = saveAppSettings;
            
            exerciseSearchInput.onkeyup = () => {
                const searchTerm = exerciseSearchInput.value.toLowerCase();
                const filteredExercises = allExercises.filter(ex => ex.toLowerCase().includes(searchTerm));
                populateExerciseSelect(filteredExercises);
            };

            exerciseSelect.onchange = () => {
                if (exerciseSelect.value) {
                    exerciseSearchInput.value = exerciseSelect.value;
                }
            };
            
            chartSelect.onchange = handleChartSelection;
            runningChartSelect.onchange = handleRunningChartSelection;

            document.getElementById('close-modal-btn').onclick = () => editModal.classList.add('hidden');
            document.getElementById('update-workout-btn').onclick = handleUpdateWorkout;
            document.getElementById('delete-workout-btn').onclick = handleDeleteWorkout;
            document.getElementById('toggle-exercise-input-btn').onclick = toggleExerciseInput;
            document.getElementById('add-set-btn').onclick = () => setsContainer.appendChild(createSetInput());
            document.getElementById('edit-add-set-btn').onclick = () => document.getElementById('edit-sets-container').appendChild(createSetInput());
            analyzeBtn.onclick = handleAnalysisRequest;
            chatForm.onsubmit = handleChatSubmit;
        }
        
        setupAuthEventListeners();
        
        // --- Dashboard, Streak & Achievements Logic ---
        async function calculateUserStats() {
            if (!userId) return { streak: 0, totalWorkouts: 0, totalWeightLifted: 0, totalDistanceRun: 0 };
            
            const workoutQuery = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
            const runsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/runs`));

            const [workoutSnapshot, runsSnapshot] = await Promise.all([getDocs(workoutQuery), getDocs(runsQuery)]);
            
            const workouts = workoutSnapshot.docs;
            const runs = runsSnapshot.docs;

            const totalWorkouts = workouts.length;
            const totalWeightLifted = workouts.reduce((sum, doc) => {
                const weights = doc.data().weights || [];
                return sum + weights.reduce((s, w) => s + w, 0);
            }, 0);
            const totalDistanceRun = runs.reduce((sum, doc) => sum + (doc.data().distance || 0), 0);

            if (workouts.length === 0) return { streak: 0, totalWorkouts, totalWeightLifted, totalDistanceRun };

            const workoutDates = [...new Set(workouts.map(doc => doc.data().date))].sort().reverse();
            
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            const lastWorkoutDate = new Date(workoutDates[0] + "T00:00:00");
            const diffFromToday = (currentDate - lastWorkoutDate) / (1000 * 60 * 60 * 24);

            if (diffFromToday > 1 && !(currentDate.getDay() === 1 && diffFromToday === 2)) {
                return { streak: 0, totalWorkouts, totalWeightLifted, totalDistanceRun };
            }

            let streak = 1;
            let iterDate = new Date(lastWorkoutDate);

            for (let i = 1; i < workoutDates.length; i++) {
                const nextDate = new Date(workoutDates[i] + "T00:00:00");
                const dayDiff = (iterDate - nextDate) / (1000 * 60 * 60 * 24);

                if (dayDiff === 1) {
                    streak++;
                } else if (dayDiff === 2 && iterDate.getDay() === 1) { 
                    streak++;
                } else {
                    break;
                }
                iterDate = nextDate;
            }
            
            return { streak, totalWorkouts, totalWeightLifted, totalDistanceRun };
        }

        async function renderDashboard(stats) {
            document.getElementById('streak-count').textContent = stats.streak;
            document.getElementById('total-workouts').textContent = stats.totalWorkouts;
            document.getElementById('total-weight').textContent = Math.round(stats.totalWeightLifted).toLocaleString();
            document.getElementById('total-distance').textContent = stats.totalDistanceRun.toFixed(1);
            
            const achievementsSnapshot = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/achievements`)));
            document.getElementById('achievements-unlocked').textContent = `${achievementsSnapshot.size}/${achievements.length}`;
        }
        
        async function checkAndUnlockAchievements(stats) {
            if (!userId) return;
            const achievementsRef = collection(db, `artifacts/${appId}/users/${userId}/achievements`);
            const snapshot = await getDocs(achievementsRef);
            const unlockedIds = snapshot.docs.map(doc => doc.id);
            
            const batch = writeBatch(db);
            let newAchievementsUnlocked = 0;

            for (const ach of achievements) {
                if (!unlockedIds.includes(ach.id) && ach.condition(stats)) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/achievements`, ach.id);
                    batch.set(docRef, { name: ach.name, unlockedAt: serverTimestamp() });
                    newAchievementsUnlocked++;
                    showMessage(`üèÜ Achievement Unlocked: ${ach.name}`, false, 'üèÜ');
                }
            }
            if (newAchievementsUnlocked > 0) await batch.commit();
        }

        function renderAchievementsPage(unlockedDocs) {
            const unlockedIds = unlockedDocs.map(doc => doc.id);
            const listEl = document.getElementById('achievements-list');
            listEl.innerHTML = '';

            achievements.forEach(ach => {
                const isUnlocked = unlockedIds.includes(ach.id);
                const card = document.createElement('div');
                card.className = `p-4 border rounded-lg flex items-center gap-4 ${isUnlocked ? 'bg-amber-50 border-amber-200' : 'bg-gray-50'}`;
                card.innerHTML = `
                    <div class="text-4xl ${isUnlocked ? '' : 'opacity-30'}">${ach.emoji}</div>
                    <div>
                        <h4 class="font-bold ${isUnlocked ? 'text-amber-800' : 'text-gray-700'}">${ach.name}</h4>
                        <p class="text-sm ${isUnlocked ? 'text-amber-600' : 'text-gray-500'}">${ach.description}</p>
                    </div>
                `;
                listEl.appendChild(card);
            });
        }
        
        // --- Data Handling & UI Updates ---
        async function handleWorkoutSubmit(e) {
            e.preventDefault();
            const tag = workoutForm['workout-tag'].value.trim() || null;
            const exercise = isAddingNewExercise ? newExerciseNameInput.value.trim() : exerciseSelect.value;
            const weights = Array.from(setsContainer.querySelectorAll('.set-weight-input')).map(input => parseFloat(input.value)).filter(w => !isNaN(w) && w > 0);
            const date = workoutForm['workout-date'].value;

            if (exercise && weights.length > 0 && date) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/workouts`), { exercise, weights, date, tag });
                    showMessage("Workout added!", false, 'üí™');
                    workoutForm.reset();
                    exerciseSearchInput.value = '';
                    setsContainer.innerHTML = '';
                    setsContainer.appendChild(createSetInput());
                    workoutForm['workout-date'].value = new Date().toISOString().split('T')[0];
                    if (isAddingNewExercise) toggleExerciseInput();
                } catch (error) { showMessage("Failed to add workout.", true, '‚ùå'); }
            } else { showMessage("Please fill all workout fields correctly.", true, '‚ùå'); }
        }
        
        function populateExerciseDropdownAndTags(workoutDocs) {
            allExercises = [...new Set(workoutDocs.map(doc => doc.data().exercise))].sort();
            const tags = [...new Set(workoutDocs.map(doc => doc.data().tag).filter(Boolean))].sort();
            
            populateExerciseSelect(allExercises);
            
            const tagList = document.getElementById('workout-tags-list');
            tagList.innerHTML = '';
            tags.forEach(tag => {
                tagList.innerHTML += `<option value="${tag}"></option>`;
            });
        }

        function populateExerciseSelect(exercises) {
            const currentSelection = exerciseSelect.value;
            exerciseSelect.innerHTML = '<option value="">Select an exercise</option>';
            exercises.forEach(ex => {
                const optionEl = document.createElement('option');
                optionEl.value = ex;
                optionEl.textContent = ex;
                exerciseSelect.appendChild(optionEl);
            });
            if (exercises.includes(currentSelection)) {
                exerciseSelect.value = currentSelection;
            }
        }
        
        function updateCalendar(workoutDocs, runDocs) {
            const workoutEvents = workoutDocs.map(doc => {
                const data = doc.data();
                const displayWeight = Array.isArray(data.weights) && data.weights.length > 0 ? Math.max(...data.weights) : data.weight || 0;
                const titlePrefix = data.tag ? `<strong>${data.tag}:</strong> ` : '';
                return { 
                    id: doc.id, 
                    title: `${data.exercise} - ${displayWeight} kg`,
                    start: data.date, 
                    extendedProps: { ...data, titlePrefix, type: 'workout' }
                };
            });
            const runEvents = runDocs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    title: `üèÉ‚Äç‚ôÇÔ∏è Run - ${data.distance} km`,
                    start: data.date,
                    extendedProps: { ...data, type: 'run' },
                    backgroundColor: '#0ea5e9',
                    borderColor: '#0ea5e9'
                }
            });

            if (calendar) {
                calendar.removeAllEvents();
                calendar.addEventSource([...workoutEvents, ...runEvents]);
            }
        }
        
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (calendar) calendar.destroy();
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' },
                eventContent: function(arg) {
                    return { html: `${arg.event.extendedProps.titlePrefix || ''}${arg.event.title}` };
                },
                eventClick: handleEventClick,
            });
            calendar.render();
        }
        
        // --- Authentication ---
        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = loginForm['email-address'].value;
            const password = loginForm['password'].value;
            const isRegistering = loginForm.dataset.register === 'true';

            try {
                if (isRegistering) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                loginForm.reset();
            } catch (error) {
                showMessage(error.message, true, '‚ùå');
            }
        }

        function toggleAuthMode() {
            const isRegistering = loginForm.dataset.register === 'true';
            const h2 = loginForm.parentElement.querySelector('h2');
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const toggleP = document.getElementById('show-register-btn').parentElement;
            if (isRegistering) {
                submitBtn.textContent = 'Sign in';
                h2.textContent = 'Sign in to your account';
                toggleP.innerHTML = `Don't have an account? <button id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">Register here</button>`;
                loginForm.dataset.register = 'false';
            } else {
                submitBtn.textContent = 'Register';
                h2.textContent = 'Create a new account';
                toggleP.innerHTML = `Already have an account? <button id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">Sign in</button>`;
                loginForm.dataset.register = 'true';
            }
            document.getElementById('show-register-btn').onclick = toggleAuthMode;
        }

        // --- Gemini AI Logic ---
        async function callGeminiAPI(prompt) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('Failed to fetch from Gemini API.');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error(error);
                return "Sorry, I couldn't get a response from the AI coach right now.";
            }
        }
        
        async function formatDataForAI() {
            if (!userId) return "No data available.";
            
            const workoutQuery = query(collection(db, `artifacts/${appId}/users/${userId}/workouts`));
            const runsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/runs`));
            const measurementQuery = query(collection(db, `artifacts/${appId}/users/${userId}/measurements`));
            const [workoutSnapshot, runsSnapshot, measurementSnapshot] = await Promise.all([getDocs(workoutQuery), getDocs(runsQuery), getDocs(measurementQuery)]);

            let dataString = "WORKOUT DATA:\n";
            workoutSnapshot.docs.map(d => d.data()).sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(w => {
                const maxWeight = Array.isArray(w.weights) ? Math.max(...w.weights) : w.weight;
                dataString += `- ${w.date}, ${w.tag ? `(${w.tag}) ` : ''}${w.exercise}: Max weight ${maxWeight} kg, Sets: ${w.weights ? w.weights.length : 1}\n`;
            });
            
            dataString += "\nRUNNING DATA:\n";
            runsSnapshot.docs.map(d => d.data()).sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(r => {
                dataString += `- ${r.date}: Distance ${r.distance} km, Duration ${r.duration} min\n`;
            });

            dataString += "\nBODY MEASUREMENT DATA:\n";
            measurementSnapshot.docs.map(d => d.data()).sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(m => {
                dataString += `- ${m.date}: ` + Object.entries(m).filter(([k, v]) => k !== 'date' && v != null).map(([k, v]) => `${k}: ${v}`).join(', ') + '\n';
            });
            return dataString;
        }

        async function handleAnalysisRequest() {
            document.getElementById('analysis-placeholder').classList.add('hidden');
            analysisResult.innerHTML = '';
            document.getElementById('analysis-loading').classList.remove('hidden');

            const data = await formatDataForAI();
            const prompt = `You are a world-class fitness and strength coach. Analyze the following data for a user. Provide a concise, encouraging, and actionable summary.
            DATA:
            ${data}
            ANALYSIS SHOULD INCLUDE:
            1. Overall progress summary on strength, exercises, and running.
            2. 1-2 exercises with most improvement.
            3. Potential plateaus in lifting or running.
            4. A comment on body composition changes. Specifically mention Skeletal Muscle Mass (SMM) and Percentage of Body Fat (PBF) trends if the data is available.
            5. A key suggestion for their next week of training based on all available data.
            6. If height and weight data are available, calculate the Body Mass Index (BMI) and comment on it.
            Keep the tone positive. Format output using markdown.`;
            
            const response = await callGeminiAPI(prompt);
            document.getElementById('analysis-loading').classList.add('hidden');
            analysisResult.innerHTML = marked.parse(response);
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput) return;
            
            chatForm.querySelector('button').disabled = true;
            chatInput.value = '';
            
            appendChatMessage(userInput, 'user');
            document.getElementById('chat-loading').classList.remove('hidden');
            
            const dataContext = await formatDataForAI();
            const prompt = `You are a fitness coach. Based on the user's data below, answer their question concisely.
            USER'S DATA: ${dataContext}
            USER'S QUESTION: "${userInput}"`;
            
            const response = await callGeminiAPI(prompt);
            document.getElementById('chat-loading').classList.add('hidden');
            appendChatMessage(response, 'gemini');
            chatForm.querySelector('button').disabled = false;
        }
        
        function appendChatMessage(message, sender) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-2 rounded-lg max-w-xs ${sender === 'user' ? 'bg-blue-500 text-white self-end ml-auto' : 'bg-gray-200 text-slate-800 self-start mr-auto'}`;
            messageDiv.innerHTML = marked.parse(message);
            
            const initialPlaceholder = chatHistory.querySelector('.text-center');
            if(initialPlaceholder) initialPlaceholder.remove();

            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // --- Form & Data Logic ---
        async function handleMeasurementSubmit(e) {
            e.preventDefault();
            const date = measurementForm['measurement-date'].value;
            if (!date) { showMessage("Please select a date.", true, '‚ùå'); return; }
            const data = { 
                date, 
                weight: parseFloat(measurementForm['body-weight'].value) || null, 
                bustLine: parseFloat(measurementForm['bust-line'].value) || null,
                waistLine: parseFloat(measurementForm['waist-line'].value) || null,
                hipLine: parseFloat(measurementForm['hip-line'].value) || null,
                biceps: parseFloat(measurementForm['biceps-size'].value) || null, 
                forearms: parseFloat(measurementForm['forearms-size'].value) || null,
                thighs: parseFloat(measurementForm['thighs-size'].value) || null,
                calves: parseFloat(measurementForm['calves-size'].value) || null,
                smm: parseFloat(measurementForm['smm'].value) || null,
                pbf: parseFloat(measurementForm['pbf'].value) || null,
                age: parseInt(measurementForm['age'].value) || null,
                height: parseFloat(measurementForm['height'].value) || null
            };
            if (!Object.values(data).some((v, i) => i > 0 && v !== null)) { showMessage("Please enter at least one measurement.", true, '‚ùå'); return; }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/measurements`, date), data, { merge: true });
                showMessage("Measurements saved!", false, '‚úÖ');
                measurementForm.reset();
                measurementForm['measurement-date'].value = new Date().toISOString().split('T')[0];
            } catch (error) { showMessage("Failed to save measurements.", true, '‚ùå'); }
        }

        function handleEventClick(info) {
             const data = info.event.extendedProps;
             if(data.type === 'run') {
                alert(`Run on ${data.date}: ${data.distance} km in ${data.duration} minutes.`);
                return;
             }
            editModal.querySelector('#modal-title').textContent = `Edit: ${data.exercise}`;
            editModal.querySelector('#edit-doc-id').value = info.event.id;
            editModal.querySelector('#edit-workout-tag').value = data.tag || '';
            editModal.querySelector('#edit-exercise-name').value = data.exercise;
            editModal.querySelector('#edit-workout-date').value = data.date;

            const editSetsContainer = document.getElementById('edit-sets-container');
            editSetsContainer.innerHTML = '';
            if (Array.isArray(data.weights) && data.weights.length > 0) {
                data.weights.forEach(weight => editSetsContainer.appendChild(createSetInput(weight)));
            } else {
                editSetsContainer.appendChild(createSetInput());
            }
            editModal.classList.remove('hidden');
        }
        
        async function handleUpdateWorkout() {
            const docId = editModal.querySelector('#edit-doc-id').value;
            const tag = editModal.querySelector('#edit-workout-tag').value.trim() || null;
            const weights = Array.from(document.getElementById('edit-sets-container').querySelectorAll('.set-weight-input')).map(input => parseFloat(input.value)).filter(w => !isNaN(w) && w > 0);
            const date = editModal.querySelector('#edit-workout-date').value;
            
            if (!docId || weights.length === 0 || !date) { showMessage("Invalid data.", true, '‚ùå'); return; }
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/workouts`, docId), { weights, date, tag });
                showMessage("Workout updated!", false, '‚úÖ');
                editModal.classList.add('hidden');
            } catch (error) { showMessage("Failed to update workout.", true, '‚ùå'); }
        }

        async function handleDeleteWorkout() {
            const docId = editModal.querySelector('#edit-doc-id').value;
            if (!docId) return;
            showConfirm("Delete this workout?", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/workouts`, docId));
                    showMessage("Workout deleted!", false, 'üóëÔ∏è');
                    editModal.classList.add('hidden');
                } catch (error) { showMessage("Delete failed.", true, '‚ùå'); }
            });
        }
        
        async function populateChartDropdown(workoutDocs) {
            if (!userId || !workoutDocs) return;
            const currentSelection = chartSelect.value;
            chartSelect.innerHTML = '<option value="">Choose data...</option>';
            
            const measurementGroup = document.createElement('optgroup');
            measurementGroup.label = "Body Measurements";
            const measurements = ['Weight', 'Bust Line', 'Waist Line', 'Hip Line', 'Biceps', 'Forearms', 'Thighs', 'Calves', 'SMM', 'PBF'];
            const measurementKeys = ['weight', 'bustLine', 'waistLine', 'hipLine', 'biceps', 'forearms', 'thighs', 'calves', 'smm', 'pbf'];

            measurements.forEach((opt, index) => {
                const valueKey = measurementKeys[index];
                measurementGroup.innerHTML += `<option value="measurement_${valueKey}">${opt}</option>`;
            });
            chartSelect.appendChild(measurementGroup);
            
            const exercises = [...new Set(workoutDocs.map(doc => doc.data().exercise))];
            
            if(exercises.length > 0) {
                const exerciseGroup = document.createElement('optgroup');
                exerciseGroup.label = "Exercises";
                exercises.sort().forEach(ex => {
                    exerciseGroup.innerHTML += `<option value="exercise_${ex}">${ex}</option>`;
                });
                chartSelect.appendChild(exerciseGroup);
            }
            chartSelect.value = currentSelection;
        }
        
        async function handleChartSelection() {
            const selectedValue = chartSelect.value;
            const chartPlaceholder = document.getElementById('chart-placeholder');
            if (!selectedValue) {
                if (progressChart) progressChart.destroy();
                chartPlaceholder.classList.remove('hidden');
                return;
            }

            chartPlaceholder.classList.add('hidden');
            const [type, key] = selectedValue.split('_');
            const collectionName = type === 'measurement' ? 'measurements' : 'workouts';
            
            let labelText;
            const labelMap = { weight: 'Weight', bustLine: 'Bust Line', waistLine: 'Waist Line', hipLine: 'Hip Line', biceps: 'Biceps', forearms: 'Forearms', thighs: 'Thighs', calves: 'Calves', smm: 'SMM (kg)', pbf: 'PBF (%)' };
            if (type === 'measurement') {
                 labelText = `${labelMap[key] || key} Progress`;
            } else {
                 labelText = `${key} Progress (kg)`;
            }

            const q = type === 'exercise' 
                ? query(collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`), where('exercise', '==', key))
                : query(collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`));

            const snapshot = await getDocs(q);
            
            const sortedData = snapshot.docs.map(doc => doc.data()).filter(d => {
                if (type === 'measurement') return d[key] != null;
                return d.weight != null || (Array.isArray(d.weights) && d.weights.length > 0);
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = sortedData.map(d => d.date);
            const data = sortedData.map(d => {
                if (type === 'measurement') return d[key];
                if (Array.isArray(d.weights) && d.weights.length > 0) return Math.max(...d.weights);
                return d.weight || 0;
            });

            drawChart(labels, data, labelText);
        }

        function drawChart(labels, data, label) {
            if (progressChart) progressChart.destroy();
            progressChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{ label, data, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.2, pointBackgroundColor: '#3b82f6', pointRadius: 4, pointHoverRadius: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
            });
        }
        
        async function handleRunningChartSelection() {
            if(!userId) return;
            const selectedValue = runningChartSelect.value;
            const placeholder = document.getElementById('running-chart-placeholder');
            
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/runs`));
            const snapshot = await getDocs(q);
            const runs = snapshot.docs.map(d => d.data()).sort((a,b) => new Date(a.date) - new Date(b.date));

            if(runs.length === 0) {
                placeholder.classList.remove('hidden');
                if(runningProgressChart) runningProgressChart.destroy();
                return;
            }
            placeholder.classList.add('hidden');

            const labels = runs.map(r => r.date);
            const data = runs.map(r => r[selectedValue]);
            const label = selectedValue === 'distance' ? 'Distance (km)' : 'Duration (min)';

            if(runningProgressChart) runningProgressChart.destroy();
            runningProgressChart = new Chart(runningChartCanvas, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{label, data, borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', fill: true, tension: 0.2}]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
            });
        }
        
        // --- UI Helpers & Modals ---
        function createSetInput(weight = '') {
            const setWrapper = document.createElement('div');
            setWrapper.className = 'flex items-center gap-2';
            setWrapper.innerHTML = `
                <input type="number" step="0.5" class="set-weight-input mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 60" value="${weight}" required>
                <button type="button" class="remove-set-btn text-red-500 hover:text-red-700 font-bold">‚úï</button>
            `;
            setWrapper.querySelector('.remove-set-btn').onclick = () => {
                if (setWrapper.parentElement.childElementCount > 1) {
                    setWrapper.remove();
                } else {
                    showMessage("You must have at least one set.", true, '‚ö†Ô∏è');
                }
            };
            return setWrapper;
        }

        function toggleExerciseInput() {
            isAddingNewExercise = !isAddingNewExercise;
            const btn = document.getElementById('toggle-exercise-input-btn');
            if (isAddingNewExercise) {
                exerciseSelect.classList.add('hidden');
                exerciseSearchInput.classList.add('hidden');
                newExerciseNameInput.classList.remove('hidden');
                newExerciseNameInput.focus();
                btn.textContent = 'Or, select an existing exercise';
            } else {
                exerciseSelect.classList.remove('hidden');
                exerciseSearchInput.classList.remove('hidden');
                newExerciseNameInput.classList.add('hidden');
                btn.textContent = 'Or, add a new exercise';
            }
        }
        
        function showMessage(text, isError = false, icon = '') {
            const modal = document.getElementById('message-modal');
            document.getElementById('message-icon').textContent = icon;
            document.getElementById('message-text').textContent = text;
            modal.querySelector('p').className = `text-center text-lg ${isError ? 'text-red-600' : 'text-slate-700'}`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 2500);
        }

        function showConfirm(text, onConfirm) {
            document.getElementById('confirm-text').textContent = text;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');
            const yesHandler = () => { onConfirm(); cleanup(); };
            const noHandler = () => cleanup();
            const cleanup = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                yesBtn.removeEventListener('click', yesHandler);
                noBtn.removeEventListener('click', noHandler);
            };
            yesBtn.addEventListener('click', yesHandler);
            noBtn.addEventListener('click', noHandler);
        }
        
        async function handleRunningSubmit(e) {
            e.preventDefault();
            const form = document.getElementById('running-form');
            const date = form['run-date'].value;
            const distance = parseFloat(form['run-distance'].value);
            const hr = parseInt(form['run-duration-hr'].value) || 0;
            const min = parseInt(form['run-duration-min'].value) || 0;
            const sec = parseInt(form['run-duration-sec'].value) || 0;
            const duration = hr * 60 + min + sec / 60;

            if(!date || !distance || duration <= 0) {
                showMessage('Please fill out all fields for the run.', true, '‚ùå');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/runs`), { date, distance, duration });
                showMessage("Run logged successfully!", false, 'üèÉ‚Äç‚ôÇÔ∏è');
                form.reset();
            } catch (error) {
                showMessage("Failed to log run.", true, '‚ùå');
            }
        }

        function applySettings(settings) {
            const runningTab = document.getElementById('tab-running');
            const distanceCard = document.getElementById('total-distance-card');
            const toggle = document.getElementById('enable-running-toggle');
            
            const isEnabled = settings?.runningLogEnabled || false;
            
            if (isEnabled) {
                runningTab.classList.remove('hidden');
                distanceCard.classList.remove('hidden');
                distanceCard.classList.add('flex');
            } else {
                runningTab.classList.add('hidden');
                distanceCard.classList.add('hidden');
                distanceCard.classList.remove('flex');
            }
            toggle.checked = isEnabled;
        }

        async function saveAppSettings() {
            if (!userId) return;
            const isEnabled = document.getElementById('enable-running-toggle').checked;
            const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/appSettings`);
            try {
                await setDoc(settingsDocRef, { runningLogEnabled: isEnabled }, { merge: true });
                showMessage("Settings saved!", false, '‚öôÔ∏è');
            } catch (error) {
                showMessage("Could not save settings.", true, '‚ùå');
            }
        }

    </script>
</body>
</html>

